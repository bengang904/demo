<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <title>WebAuthn 登录 + 扫码跨设备登录示例</title>
  <style>
    #qr-scanner {
      display: none;
      margin-top: 20px;
    }
    #video {
      width: 300px;
      height: 300px;
      border: 1px solid #ccc;
    }
  </style>
</head>
<body>
  <h2>WebAuthn 注册和登录示例</h2>

  <button id="registerBtn">注册</button>
  <button id="loginBtn">登录</button>

  <div id="output" style="white-space: pre-wrap; margin-top: 20px;"></div>

  <div id="qr-scanner">
    <h3>请扫码以完成跨设备登录</h3>
    <video id="video" autoplay></video>
    <div id="qr-result" style="margin-top:10px; color: green; font-weight: bold;"></div>
  </div>

  <!-- 引入 jsQR 库，二维码识别 -->
  <script src="https://cdn.jsdelivr.net/npm/jsqr@1.4.0/dist/jsQR.js"></script>

  <script>
    const output = document.getElementById('output');
    const qrScanner = document.getElementById('qr-scanner');
    const video = document.getElementById('video');
    const qrResult = document.getElementById('qr-result');

    let videoStream;

    function bufferToBase64Url(buffer) {
      return btoa(String.fromCharCode(...new Uint8Array(buffer)))
        .replace(/\+/g, '-').replace(/\//g, '_').replace(/=+$/, '');
    }

    async function getRegisterOptions() {
      return {
        publicKey: {
          challenge: Uint8Array.from(window.crypto.getRandomValues(new Uint8Array(32))),
          rp: { name: "示例网站" },
          user: {
            id: Uint8Array.from(window.crypto.getRandomValues(new Uint8Array(16))),
            name: "user@example.com",
            displayName: "示例用户"
          },
          pubKeyCredParams: [
            { type: "public-key", alg: -7 },
            { type: "public-key", alg: -257 }
          ],
          timeout: 60000,
          attestation: "direct"
        }
      };
    }

    async function getLoginOptions() {
      return {
        publicKey: {
          challenge: Uint8Array.from(window.crypto.getRandomValues(new Uint8Array(32))),
          allowCredentials: [],
          timeout: 60000,
          userVerification: "preferred"
        }
      };
    }

    async function startQrScanner(onScan) {
      qrScanner.style.display = 'block';
      qrResult.textContent = '正在启动摄像头...';

      try {
        videoStream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: 'environment' } });
        video.srcObject = videoStream;

        const canvas = document.createElement('canvas');
        const context = canvas.getContext('2d');

        function scanFrame() {
          if (video.readyState === video.HAVE_ENOUGH_DATA) {
            canvas.width = video.videoWidth;
            canvas.height = video.videoHeight;
            context.drawImage(video, 0, 0, canvas.width, canvas.height);
            const imageData = context.getImageData(0, 0, canvas.width, canvas.height);
            const code = jsQR(imageData.data, imageData.width, imageData.height, { inversionAttempts: "dontInvert" });
            if (code) {
              qrResult.textContent = '二维码内容: ' + code.data;
              onScan(code.data);
              stopQrScanner();
              return;
            } else {
              qrResult.textContent = '未检测到二维码，请对准二维码';
            }
          }
          requestAnimationFrame(scanFrame);
        }
        scanFrame();
      } catch (err) {
        qrResult.textContent = '无法启动摄像头: ' + err;
      }
    }

    function stopQrScanner() {
      qrScanner.style.display = 'none';
      if (videoStream) {
        videoStream.getTracks().forEach(track => track.stop());
        videoStream = null;
      }
    }

    document.getElementById('registerBtn').addEventListener('click', async () => {
      output.textContent = '注册中...';
      try {
        const options = await getRegisterOptions();
        const credential = await navigator.credentials.create(options);
        const rawId = credential.rawId;
        output.textContent = `注册成功!\nCredential ID: ${bufferToBase64Url(rawId)}\n`;
      } catch (e) {
        output.textContent = '注册失败: ' + e;
      }
    });

    document.getElementById('loginBtn').addEventListener('click', async () => {
      output.textContent = '登录中...';
      try {
        const options = await getLoginOptions();
        const assertion = await navigator.credentials.get(options);
        const rawId = assertion.rawId;
        output.textContent = `登录成功!\nCredential ID: ${bufferToBase64Url(rawId)}\n`;

        // 登录成功后启动扫码界面
        startQrScanner(qrData => {
          // 这里拿到扫码字符串，可发送给服务器验证或执行其他逻辑
          output.textContent += `\n扫码内容已获取:\n${qrData}\n\n你可以根据扫码内容完成跨设备登录验证。`;
        });
      } catch (e) {
        output.textContent = '登录失败: ' + e;
      }
    });
  </script>
</body>
</html>
