<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <title>简单 WebAuthn 示例</title>
</head>
<body>
  <h2>WebAuthn 注册和登录示例1</h2>

  <button id="registerBtn">注册</button>
  <button id="loginBtn">登录</button>

  <div id="output" style="white-space: pre-wrap; margin-top: 20px;"></div>

  <script>
    const output = document.getElementById('output');

    // 将 ArrayBuffer 转为 Base64Url 字符串
    function bufferToBase64Url(buffer) {
      return btoa(String.fromCharCode(...new Uint8Array(buffer)))
        .replace(/\+/g, '-').replace(/\//g, '_').replace(/=+$/, '');
    }

    // 将 Base64Url 字符串转为 ArrayBuffer
    function base64UrlToBuffer(base64url) {
      base64url = base64url.replace(/-/g, '+').replace(/_/g, '/');
      const padLength = (4 - (base64url.length % 4)) % 4;
      base64url += '='.repeat(padLength);
      const str = atob(base64url);
      const buffer = new ArrayBuffer(str.length);
      const byteArray = new Uint8Array(buffer);
      for (let i = 0; i < str.length; i++) {
        byteArray[i] = str.charCodeAt(i);
      }
      return buffer;
    }

    async function getRegisterOptions() {
      return {
        publicKey: {
          challenge: Uint8Array.from(window.crypto.getRandomValues(new Uint8Array(32))),
          rp: { name: "示例网站" },
          user: {
            id: Uint8Array.from(window.crypto.getRandomValues(new Uint8Array(16))),
            name: "user@example.com",
            displayName: "示例用户"
          },
          pubKeyCredParams: [
            { type: "public-key", alg: -7 },  
            { type: "public-key", alg: -257 }
          ],
          timeout: 60000,
          attestation: "direct"
        }
      };
    }

    // 这里从 localStorage 读存储的 Credential ID，放入 allowCredentials
    async function getLoginOptions() {
      const storedCredentialId = localStorage.getItem('credentialId');
      let allowCredentials = [];
      if (storedCredentialId) {
        allowCredentials = [{
          type: 'public-key',
          id: base64UrlToBuffer(storedCredentialId),
          // transports 可选，比如 ['usb', 'nfc', 'ble', 'internal']
        }];
      }

      return {
        publicKey: {
          challenge: Uint8Array.from(window.crypto.getRandomValues(new Uint8Array(32))),
          allowCredentials,
          timeout: 60000,
          userVerification: "preferred"
        }
      };
    }

    document.getElementById('registerBtn').addEventListener('click', async () => {
      output.textContent = '注册中...';
      try {
        const options = await getRegisterOptions();

        const credential = await navigator.credentials.create(options);

        const rawId = credential.rawId;
        const credentialIdBase64 = bufferToBase64Url(rawId);

        // 存储 Credential ID 到 localStorage
        localStorage.setItem('credentialId', credentialIdBase64);

        output.textContent = `注册成功!\nCredential ID 已存储。\nID: ${credentialIdBase64}`;
      } catch (e) {
        output.textContent = '注册失败: ' + e;
      }
    });

    document.getElementById('loginBtn').addEventListener('click', async () => {
      output.textContent = '登录中...';
      try {
        const options = await getLoginOptions();

        const assertion = await navigator.credentials.get(options);

        const rawId = assertion.rawId;
        const credentialIdBase64 = bufferToBase64Url(rawId);

        output.textContent = `登录成功!\nCredential ID: ${credentialIdBase64}`;
      } catch (e) {
        output.textContent = '登录失败: ' + e;
      }
    });
  </script>
</body>
</html>
