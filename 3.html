<!DOCTYPE html>
<html lang="zh">
<head>
  <meta charset="UTF-8">
  <title>WebAuthn 示例</title>
</head>
<body>
  <h2>WebAuthn 示例</h2>

  <button onclick="register()">注册</button>
  <button onclick="login()">登录</button>

  <pre id="output"></pre>

  <script>
    const output = document.getElementById('output');

    // 模拟从后端获取 challenge 的函数（真实情况应通过 fetch 获取）
    async function getChallenge() {
      const array = new Uint8Array(32);
      crypto.getRandomValues(array);
      return array;
    }

    // Base64 编解码工具
    const base64url = {
      encode: (buffer) => {
        return btoa(String.fromCharCode(...new Uint8Array(buffer)))
          .replace(/\+/g, '-').replace(/\//g, '_').replace(/=+$/, '');
      },
      decode: (str) => {
        str = str.replace(/-/g, '+').replace(/_/g, '/');
        const pad = str.length % 4 === 0 ? '' : '='.repeat(4 - (str.length % 4));
        const binary = atob(str + pad);
        const bytes = new Uint8Array(binary.length);
        for (let i = 0; i < binary.length; i++) {
          bytes[i] = binary.charCodeAt(i);
        }
        return bytes.buffer;
      }
    };

    async function register() {
      const challenge = await getChallenge();
      const publicKey = {
        challenge,
        rp: {
          name: "示例网站"
        },
        user: {
          id: new Uint8Array(16), // 实际应是用户唯一ID
          name: "user@example.com",
          displayName: "示例用户"
        },
        pubKeyCredParams: [
          { type: "public-key", alg: -7 }, // ES256
        ],
        authenticatorSelection: {
          userVerification: "preferred"
        },
        timeout: 60000,
        attestation: "none"
      };

      try {
        const credential = await navigator.credentials.create({ publicKey });
        output.innerText = "注册成功！凭据ID:\n" +
          base64url.encode(credential.rawId);
        // 实际应将凭据发送到服务器进行验证和存储
      } catch (err) {
        output.innerText = "注册失败: " + err;
      }
    }

    async function login() {
      const challenge = await getChallenge();
      const credentialId = prompt("请输入注册时的凭据ID（base64url 编码）");
      if (!credentialId) return;

      const publicKey = {
        challenge,
        allowCredentials: [{
          id: base64url.decode(credentialId),
          type: "public-key"
        }],
        timeout: 60000,
        userVerification: "preferred"
      };

      try {
        const assertion = await navigator.credentials.get({ publicKey });
        output.innerText = "登录成功！凭据ID:\n" +
          base64url.encode(assertion.rawId);
        // 实际应将 assertion.response 发送给服务器进行验证
      } catch (err) {
        output.innerText = "登录失败: " + err;
      }
    }
  </script>
</body>
</html>
