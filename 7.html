<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>AR Ground Plane Tracker</title>
  <script src="https://cdn.jsdelivr.net/npm/aframe@1.2.0/dist/aframe.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/aframe-ar.js@4.0.0/dist/aframe-ar.js"></script>
  <style>
    body { margin: 0; }
    canvas { display: block; }
  </style>
</head>
<body style="margin: 0; overflow: hidden;">
  <!-- 使用 A-Frame 初始化 WebXR AR 场景 -->
  <a-scene embedded arjs="sourceType: webcam; debugUIEnabled: false;">
    <!-- AR 摄像头 -->
    <a-entity camera></a-entity>

    <!-- 地面网格 -->
    <a-entity id="grid" position="0 0 0" scale="2 2 2">
      <a-plane color="green" height="10" width="10" rotation="-90 0 0"></a-plane>
    </a-entity>
    
    <!-- 可以插入其他元素 -->
  </a-scene>

  <!-- 开始 WebXR 设备 -->
  <script>
    document.querySelector('a-scene').addEventListener('loaded', () => {
      const scene = document.querySelector('a-scene');
      const xr = scene.querySelector('[camera]');
      // 使用WebXRAPI初始化环境
      navigator.xr.requestSession('immersive-ar', {
        requiredFeatures: ['hit-test'],
        optionalFeatures: ['local', 'plane-detection']
      }).then(session => {
        session.addEventListener('end', () => {
          // 当AR会话结束时的处理
        });

        // 开始会话
        const xrReferenceSpace = session.requestReferenceSpace('local');
        const hitTestSource = xr.createHitTestSource({
          space: xrReferenceSpace
        });

        // 定时更新每一帧
        function onXRFrame(time, frame) {
          const hitTestResults = frame.getHitTestResults(hitTestSource);
          if (hitTestResults.length > 0) {
            const hitPose = hitTestResults[0].getPose(xrReferenceSpace);
            if (hitPose) {
              // 获取检测到的平面并更新网格位置
              const position = hitPose.transform.position;
              const gridEntity = document.querySelector('#grid');
              gridEntity.setAttribute('position', position);
            }
          }
          session.requestAnimationFrame(onXRFrame);
        }
        session.requestAnimationFrame(onXRFrame);
      });
    });
  </script>
</body>
</html>
