<!DOCTYPE html>
<html lang="zh">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>WebXR AR Demo</title>
  <style>
    body { margin: 0; overflow: hidden; }
    canvas { display: block; }
  </style>
</head>
<body>
  <h1>WebXR AR 示例</h1>
  <button id="start-btn">开始AR</button>
  <script>
    let xrSession = null;
    let xrReferenceSpace = null;
    let xrViewerPose = null;
    let xrFrame = null;

    const startBtn = document.getElementById('start-btn');

    // 检查浏览器是否支持 WebXR
    if (!navigator.xr) {
      alert("你的浏览器不支持 WebXR API！");
    }

    // 开始 AR 会话
    startBtn.addEventListener('click', async () => {
      try {
        // 请求 WebXR AR 会话
        xrSession = await navigator.xr.requestSession('immersive-ar', {
          requiredFeatures: ['hit-test']
        });

        xrSession.addEventListener('end', onSessionEnd);

        const canvas = document.createElement('canvas');
        document.body.appendChild(canvas);

        // 创建一个 WebXR 渲染目标
        const gl = canvas.getContext('webgl', { xrCompatible: true });
        const xrLayer = new XRWebGLLayer(xrSession, gl);
        xrSession.updateRenderState({ baseLayer: xrLayer });

        // 获取XR参考空间
        xrReferenceSpace = await xrSession.requestReferenceSpace('local');

        // 开始渲染循环
        xrSession.requestAnimationFrame(onXRFrame);
        await xrSession.start();

      } catch (error) {
        console.error('AR会话启动失败:', error);
      }
    });

    // AR 渲染回调
    function onXRFrame(t, frame) {
      xrFrame = frame;
      const session = frame.session;
      const viewerPose = frame.getViewerPose(xrReferenceSpace);

      if (viewerPose) {
        xrViewerPose = viewerPose;
        renderScene();
      }

      session.requestAnimationFrame(onXRFrame);
    }

    // 渲染场景
    function renderScene() {
      const gl = xrFrame.session.baseLayer.context;
      gl.clearColor(0, 0, 0, 1);
      gl.clear(gl.COLOR_BUFFER_BIT | gl.DEPTH_BUFFER_BIT);

      if (xrViewerPose) {
        // 这里可以插入AR物体渲染代码，如渲染一个3D模型等
      }
    }

    // 会话结束时的回调
    function onSessionEnd() {
      xrSession = null;
      alert('AR会话已结束');
    }

  </script>
</body>
</html>
