<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>WebXR 地面检测增强版</title>
  <style>
    body, html {
      margin: 0; overflow: hidden; height: 100%; background: #222;
      font-family: sans-serif;
      user-select: none;
    }
    #info {
      position: absolute; top: 10px; left: 10px;
      color: #0f0; font-weight: bold; z-index: 10;
      background: rgba(0,0,0,0.6); padding: 8px 12px; border-radius: 5px;
    }
    #startBtn {
      position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
      padding: 16px 32px; font-size: 18px; background: #0a0; color: #fff; border: none; border-radius: 8px;
      cursor: pointer;
      user-select: none;
      box-shadow: 0 0 15px #0f0;
    }
    #startBtn:hover { background: #0c0; }
  </style>
</head>
<body>
  <div id="info">点击“开始 AR”按钮启动，检测地面后显示绿色网格平面，点击地面放置盒子</div>
  <button id="startBtn">开始 AR</button>

  <script src="https://cdn.jsdelivr.net/npm/three@0.150.1/build/three.min.js"></script>

  <script>
    let camera, scene, renderer;
    let xrSession = null;
    let hitTestSource = null;
    let referenceSpace = null;
    let viewerSpace = null;

    let reticle;    // 绿色网格平面
    let placedObject = null;  // 放置的3D模型

    const startBtn = document.getElementById('startBtn');
    const info = document.getElementById('info');

    startBtn.addEventListener('click', () => {
      startBtn.style.display = 'none';
      info.textContent = '启动中...';
      startXR();
    });

    init();

    function init() {
      scene = new THREE.Scene();

      camera = new THREE.PerspectiveCamera(70, window.innerWidth / window.innerHeight, 0.01, 20);

      renderer = new THREE.WebGLRenderer({ antialias: true, alpha: true });
      renderer.setSize(window.innerWidth, window.innerHeight);
      renderer.xr.enabled = true;
      document.body.appendChild(renderer.domElement);

      // 光照
      const ambientLight = new THREE.AmbientLight(0xffffff, 0.7);
      scene.add(ambientLight);

      const directionalLight = new THREE.DirectionalLight(0xffffff, 0.5);
      directionalLight.position.set(0, 10, 0);
      scene.add(directionalLight);

      // 网格平面
      const geometry = new THREE.PlaneGeometry(1, 1, 10, 10);
      const material = new THREE.MeshBasicMaterial({
        color: 0x00ff00,
        opacity: 0,
        transparent: true,
        wireframe: true,
        wireframeLinewidth: 2
      });
      reticle = new THREE.Mesh(geometry, material);
      reticle.rotation.x = - Math.PI / 2; // 水平
      reticle.visible = false;
      scene.add(reticle);

      window.addEventListener('resize', onWindowResize, false);

      // 点击放置盒子
      renderer.domElement.addEventListener('click', onClick);
    }

    function onWindowResize() {
      camera.aspect = window.innerWidth / window.innerHeight;
      camera.updateProjectionMatrix();
      renderer.setSize(window.innerWidth, window.innerHeight);
    }

    async function startXR() {
      if (navigator.xr) {
        try {
          xrSession = await navigator.xr.requestSession('immersive-ar', {
            requiredFeatures: ['hit-test', 'local-floor']
          });
          renderer.xr.setSession(xrSession);

          referenceSpace = await xrSession.requestReferenceSpace('local-floor');
          viewerSpace = await xrSession.requestReferenceSpace('viewer');

          hitTestSource = await xrSession.requestHitTestSource({ space: viewerSpace });

          xrSession.addEventListener('end', () => {
            xrSession = null;
            hitTestSource = null;
            reticle.visible = false;
            placedObject = null;
            info.textContent = 'AR 会话结束';
            startBtn.style.display = 'block';
          });

          info.textContent = 'AR 已启动，扫描地面中...';

          xrSession.requestAnimationFrame(onXRFrame);
        } catch (e) {
          alert('无法启动 WebXR AR: ' + e);
          startBtn.style.display = 'block';
          info.textContent = '启动失败，您的设备或浏览器可能不支持 WebXR AR';
        }
      } else {
        alert('您的设备或浏览器不支持 WebXR');
        startBtn.style.display = 'block';
        info.textContent = 'WebXR 不支持';
      }
    }

    function onXRFrame(time, frame) {
      let session = frame.session;
      session.requestAnimationFrame(onXRFrame);

      const pose = frame.getViewerPose(referenceSpace);
      if (!pose) return;

      const hitTestResults = frame.getHitTestResults(hitTestSource);

      if (hitTestResults.length > 0) {
        const hit = hitTestResults[0];
        const hitPose = hit.getPose(referenceSpace);

        // 显示网格平面并淡入动画
        if (!reticle.visible) {
          reticle.visible = true;
          new TWEEN.Tween(reticle.material)
            .to({ opacity: 0.6 }, 300)
            .start();
        }

        reticle.position.set(hitPose.transform.position.x, hitPose.transform.position.y, hitPose.transform.position.z);
        reticle.quaternion.set(
          hitPose.transform.orientation.x,
          hitPose.transform.orientation.y,
          hitPose.transform.orientation.z,
          hitPose.transform.orientation.w
        );

      } else {
        // 未检测到地面时淡出并隐藏
        if (reticle.visible) {
          new TWEEN.Tween(reticle.material)
            .to({ opacity: 0 }, 300)
            .onComplete(() => reticle.visible = false)
            .start();
        }
      }

      renderer.render(scene, camera);
      TWEEN.update(time);
    }

    // 点击放置3D盒子
    function onClick(event) {
      if (!reticle.visible) return;

      if (!placedObject) {
        // 创建一个旋转盒子
        const boxGeo = new THREE.BoxGeometry(0.2, 0.2, 0.2);
        const boxMat = new THREE.MeshStandardMaterial({ color: 0x0077ff });
        placedObject = new THREE.Mesh(boxGeo, boxMat);
        scene.add(placedObject);

        // 简单旋转动画
        function rotateBox() {
          if (!placedObject) return;
          placedObject.rotation.y += 0.01;
          requestAnimationFrame(rotateBox);
        }
        rotateBox();
      }
      // 把盒子放到 reticle 位置
      placedObject.position.copy(reticle.position);
      placedObject.quaternion.copy(reticle.quaternion);
      info.textContent = '已放置盒子，继续扫描地面';
    }

    // TWEEN.js 动画库（轻量）
    // 直接用内联脚本导入 https://cdnjs.cloudflare.com/ajax/libs/tween.js/18.6.4/tween.umd.js
  </script>

  <!-- 引入 TWEEN.js 用于平滑动画 -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/tween.js/18.6.4/tween.umd.js"></script>
</body>
</html>
