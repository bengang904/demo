<!DOCTYPE html>
<html lang="zh">
<head>
  <meta charset="UTF-8">
  <title>敲门声识别 - YAMNet</title>
</head>
<body>
  <h1>🎧 实时敲门声检测</h1>
  <p id="status">加载模型中，请稍候…</p>

  <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@4.12.0"></script>
  <script>
    (async () => {
      const modelUrl = "https://storage.googleapis.com/tfjs-models/savedmodel/yamnet/model.json";
      const model = await tf.loadGraphModel(modelUrl);
      document.getElementById('status').innerText = '模型加载完成，正在请求麦克风权限…';

      const stream = await navigator.mediaDevices.getUserMedia({ audio: { channelCount: 1, sampleRate: 44100 } });
      const audioCtx = new AudioContext({ sampleRate: 44100 });
      const source = audioCtx.createMediaStreamSource(stream);
      const processor = audioCtx.createScriptProcessor(4096, 1, 1);
      source.connect(processor);
      processor.connect(audioCtx.destination);

      let buffer = new Float32Array();

      processor.onaudioprocess = (e) => {
        const data = e.inputBuffer.getChannelData(0);
        buffer = concatFloat32(buffer, data);
        processIfReady();
      };

      const concatFloat32 = (a, b) => {
        const result = new Float32Array(a.length + b.length);
        result.set(a);
        result.set(b, a.length);
        return result;
      };

      const classNames = await fetch("https://storage.googleapis.com/tfjs-models/savedmodel/yamnet/yamnet_class_map.csv")
        .then(r => r.text())
        .then(text => text.split("\n").map(line => line.split(",")[2]));

      const processIfReady = () => {
        const sampleRate = 44100;
        const requiredLength = 0.975 * sampleRate; // YAMNet expects ~0.975s
        if (buffer.length >= requiredLength) {
          const segment = buffer.slice(0, requiredLength);
          buffer = buffer.slice(requiredLength / 2); // overlap 50%
          runModel(segment);
        }
      };

      const runModel = async (segment) => {
        const floatTensor = tf.tensor(segment, [segment.length]);
        const resampled = tf.image.resizeBilinear(floatTensor.reshape([1, segment.length, 1]), [16000, 1]).reshape([1, 16000]);
        const prediction = model.predict(resampled);
        const scores = prediction.arraySync()[0];
        const maxIdx = scores.indexOf(Math.max(...scores));
        const label = classNames[maxIdx];
        const prob = scores[maxIdx];

        if (prob > 0.5 && /knock|door/i.test(label)) {
          document.getElementById('status').innerText = `🔔 检测到：${label}（${(prob * 100).toFixed(1)}%）`;
        }
        prediction.dispose();
        resampled.dispose();
        floatTensor.dispose();
      };

      document.getElementById('status').innerText = '✅ 正在监听中… 请敲一下桌子或门试试';
    })();
  </script>
</body>
</html>
