<!DOCTYPE html>
<html>
<head><meta charset="utf-8"><title>YAMNet 敲门声识别</title></head>
<body>
  <h1>实时敲门声检测</h1>
  <p id="status">加载中...</p>

  <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs"></script>
  <script>
  (async () => {
    const modelUrl = 'https://tfhub.dev/google/tfjs-model/yamnet/tfjs/1/model.json';
    const model = await tf.loadGraphModel(modelUrl, {fromTFHub: true});
    document.getElementById('status').innerText = '模型加载完成，正在初始化麦克风…';

    const stream = await navigator.mediaDevices.getUserMedia({audio: {channelCount: 1, sampleRate: 16000}});
    const audioCtx = new AudioContext({sampleRate:16000});
    const source = audioCtx.createMediaStreamSource(stream);
    const recorder = audioCtx.createScriptProcessor(4096, 1, 1);
    source.connect(recorder);
    recorder.connect(audioCtx.destination);

    let buffer = new Float32Array();

    recorder.onaudioprocess = e => {
      const data = e.inputBuffer.getChannelData(0);
      buffer = concatenate(buffer, data);
      processFrames();
    };

    const classMap = await fetch(modelUrl.replace('model.json','class_map.csv'))
                           .then(r=>r.text())
                           .then(txt=>txt.split('\n').slice(1).map(s=>s.split(',')[2]));

    async function processFrames() {
      while (buffer.length >= 0.96 * 16000) {
        const frame = buffer.slice(0, 0.96 * 16000);
        buffer = buffer.slice(0.48 * 16000);
        const input = tf.tensor(frame, [1, frame.length]);
        const result = model.execute({audio: input}, 'Identity');
        const scores = result.arraySync()[0];
        const maxIdx = scores.indexOf(Math.max(...scores));
        const label = classMap[maxIdx];
        const prob = scores[maxIdx];
        if (prob > 0.4 && /knock|door/i.test(label)) {
          document.getElementById('status').innerText = `🔔检测到：${label} (${(prob*100).toFixed(1)}%)`;
        }
        input.dispose();
        result.dispose();
      }
    }

    function concatenate(a, b){
      const c = new Float32Array(a.length + b.length);
      c.set(a); c.set(b, a.length);
      return c;
    }

    document.getElementById('status').innerText = '监听中…';
  })();
  </script>
</body>
</html>
