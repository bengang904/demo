<!DOCTYPE html>
<html lang="zh">
<head>
  <meta charset="utf-8">
  <title>环境声识别 + 频谱图</title>
  <style>
    body {
      font-family: sans-serif;
      background: #111;
      color: #fff;
      text-align: center;
    }
    canvas {
      display: block;
      margin: 20px auto;
      background: #222;
      border: 1px solid #444;
    }
  </style>
  <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@4.17.0"></script>
  <script src="https://cdn.jsdelivr.net/npm/@tensorflow-models/yamnet"></script>
</head>
<body>
  <h2>环境声音识别 + 频谱图</h2>
  <div id="volume">音量: ...</div>
  <canvas id="canvas" width="600" height="200"></canvas>
  <h3 id="result">正在加载模型...</h3>

  <script>
    let model;
    let audioCtx;
    let analyser;
    let source;
    let canvas, ctx, width, height;
    let floatBuffer = [];

    async function initModel() {
      model = await yamnet.load();
      document.getElementById('result').innerText = "模型已加载，开始识别...";
    }

    async function startAudio() {
      const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
      audioCtx = new (window.AudioContext || window.webkitAudioContext)();
      source = audioCtx.createMediaStreamSource(stream);
      analyser = audioCtx.createAnalyser();
      analyser.fftSize = 256;
      source.connect(analyser);

      const processor = audioCtx.createScriptProcessor(4096, 1, 1);
      source.connect(processor);
      processor.connect(audioCtx.destination);

      processor.onaudioprocess = (e) => {
        const input = e.inputBuffer.getChannelData(0);
        floatBuffer.push(...input);

        // 每 1 秒做一次识别（YAMNet 期望 16kHz 采样率）
        if (floatBuffer.length >= 16000) {
          const slice = floatBuffer.slice(0, 16000);
          floatBuffer = floatBuffer.slice(8000); // 重叠 0.5 秒提高稳定性
          predict(slice);
        }
      };

      drawSpectrum();
    }

    async function predict(data) {
      const predictions = await model.predict(new Float32Array(data));
      if (predictions && predictions.length > 0) {
        const top = predictions[0]; // 置信度最高的
        document.getElementById('result').innerText =
          `识别结果: ${top.className} (${(top.score * 100).toFixed(1)}%)`;
      }
    }

    function drawSpectrum() {
      const dataArray = new Uint8Array(analyser.frequencyBinCount);
      canvas = document.getElementById('canvas');
      ctx = canvas.getContext('2d');
      width = canvas.width;
      height = canvas.height;

      function draw() {
        analyser.getByteFrequencyData(dataArray);
        let sum = dataArray.reduce((a, b) => a + b, 0);
        let avg = sum / dataArray.length;
        document.getElementById('volume').innerText = `音量: ${avg.toFixed(2)}`;

        ctx.clearRect(0, 0, width, height);
        let barWidth = width / dataArray.length;
        for (let i = 0; i < dataArray.length; i++) {
          let barHeight = dataArray[i];
          ctx.fillStyle = `rgb(${barHeight + 100}, 50, 150)`;
          ctx.fillRect(i * barWidth, height - barHeight, barWidth - 1, barHeight);
        }

        requestAnimationFrame(draw);
      }

      draw();
    }

    initModel().then(startAudio).catch(err => {
      console.error('初始化失败：', err);
      alert('请允许访问麦克风，并确保联网以加载模型');
    });
  </script>
</body>
</html>

