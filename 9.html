<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <title>文字生成视频（画中画）</title>
  <style>
    body {
      font-family: sans-serif;
      text-align: center;
      margin: 50px;
    }
    canvas {
      border: 1px solid #ccc;
      display: block;
      margin: 20px auto;
    }
    textarea {
      width: 80%;
      height: 100px;
    }
    #video {
      display: none;
      width: 640px;
      height: 360px;
      margin-top: 20px;
    }
  </style>
</head>
<body>
  <h2>输入文字，生成视频并进入画中画</h2>
  <textarea id="text" placeholder="输入要播放的文字"></textarea><br>
  <button onclick="generateVideo()">生成视频并播放</button>
  <button onclick="enterPiP()">进入画中画</button>

  <canvas id="canvas" width="640" height="360"></canvas>
  <video id="video" controls></video>

  <script>
    const canvas = document.getElementById('canvas');
    const ctx = canvas.getContext('2d');
    const videoEl = document.getElementById('video');

    let pipSupported = !!document.pictureInPictureEnabled;

    async function generateVideo() {
      const text = document.getElementById('text').value.trim();
      if (!text) {
        alert('请输入内容');
        return;
      }

      const stream = canvas.captureStream(30); // 30fps
      const recorder = new MediaRecorder(stream, { mimeType: "video/webm" });
      const chunks = [];

      recorder.ondataavailable = (e) => chunks.push(e.data);
      recorder.onstop = async () => {
        const blob = new Blob(chunks, { type: "video/webm" });
        const url = URL.createObjectURL(blob);
        videoEl.src = url;
        videoEl.style.display = 'block';
        await videoEl.play();

        // 自动进入画中画
        if (pipSupported) {
          try {
            await videoEl.requestPictureInPicture();
          } catch (err) {
            console.warn('自动进入画中画失败：', err);
          }
        }
      };

      // 开始语音和画面录制
      recorder.start();

      const utter = new SpeechSynthesisUtterance(text);
      speechSynthesis.speak(utter);

      let startTime = Date.now();
      let duration = text.length * 200;

      function drawFrame() {
        let elapsed = Date.now() - startTime;
        let charsToShow = Math.floor(elapsed / 200);
        let content = text.slice(0, charsToShow);

        ctx.fillStyle = "white";
        ctx.fillRect(0, 0, canvas.width, canvas.height);
        ctx.fillStyle = "black";
        ctx.font = "28px sans-serif";
        ctx.textAlign = "center";
        ctx.textBaseline = "middle";
        ctx.fillText(content, canvas.width / 2, canvas.height / 2);

        if (elapsed < duration) {
          requestAnimationFrame(drawFrame);
        } else {
          recorder.stop();
        }
      }

      drawFrame();
    }

    async function enterPiP() {
      if (!document.pictureInPictureEnabled) {
        alert('您的浏览器不支持画中画');
        return;
      }
      if (videoEl !== document.pictureInPictureElement) {
        try {
          await videoEl.requestPictureInPicture();
        } catch (err) {
          alert('进入画中画失败：' + err.message);
        }
      } else {
        await document.exitPictureInPicture();
      }
    }
  </script>
</body>
</html>
